#define _CRT_SECURE_NO_WARNINGS
#include <stdio.h>
#include <math.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include <locale.h>

void dziedzina(float *wmindziedziny, float *wmaxdziedziny) {
	printf("Podaj wartosc minimalna dziedziny \t\n");
	scanf("%f", wmindziedziny);
	while (getchar() != '\n');
	printf("Podaj wartosc maksymalna dziedziny \t\n");
	scanf("%f", wmaxdziedziny);
	while (getchar() != '\n');
	if (*wmindziedziny >= *wmaxdziedziny) {
		printf("Wartosc minimalna nie moze byc wieksza od wartosci maksymalnej\n");
		dziedzina(wmindziedziny, wmaxdziedziny);
	}
	system("cls");
}

void wspolczynniki_funkcji(float *tablica) {
	int i;
	char z;
	for (z = 'A', i = 0; i < 5; i++, z++) {
		printf("Podaj wspolczynnik %c funkcji\n", z);
		scanf("%f", &tablica[i]);
		while (getchar() != '\n');
	}
}

void wyswietl(float wyniki[], int rozmiar) {
	int i;
	if (wyniki != NULL) {
		for (i = 0; i < rozmiar; i++)
			printf("%f\n", wyniki[i]);
	}
}

void wartosci_funkcji(float wmindziedziny, float wmaxdziedziny, float próbkowanie, float wyniki[], float wspolczynniki[], int rozmiar) {
	int i;
	float x = wmindziedziny;
	float a = wspolczynniki[0];
	float b = wspolczynniki[1];
	float c = wspolczynniki[2];
	float d = wspolczynniki[3];
	float e = wspolczynniki[4];
	printf("Wzor funkcji jest nastepujacy: y = %f * sin(%f * x^2) + %f * cos(%f * x^2) + %f \n ", a, b, c, d, e);
	if (wyniki != NULL) {
		printf("Wartosci funkcji to\n");
		for (i = 0; i < rozmiar; i++)
		{
			wyniki[i] = (a*sin(b*(x*x)) + c*cos(d*(x*x)) + e);
			x = x + próbkowanie;
		}
	}
}

void ZapisCSV(float *dane, int rozmiar, char *nazwa) {
	FILE *Wsk_do_pliku;
	int i;
	Wsk_do_pliku = fopen(nazwa, "w");
	if (Wsk_do_pliku == NULL)
	{
		printf("BLAD!\n");
	}
	else {
		for (i = 0; i < rozmiar; i++) {
			fprintf(Wsk_do_pliku, "%f\n", dane[i]);
		}
		fclose(Wsk_do_pliku);
		printf("Zapisano pomyslnie\n");
	}
}

void generator_szumu(int rozmiar, float *szum, float *wyniki) {
	int i;
	int liczba_probek = rand() % rozmiar;
	int z;
	int losowe_probki = 0;
	float *tablica = (float*)calloc(rozmiar, sizeof(float));
	srand(time(NULL));
	if (szum != NULL) {
		printf("Zaszumione wyniki:\n");
		for (i = 0; i < rozmiar; i++) {
			tablica[i] = wyniki[i];
		}
		for (z = 0; z < liczba_probek; z++) {
			losowe_probki = rand() % rozmiar;
			szum[losowe_probki] = (((rand() % 700) *1.1) / 500 - 0.1) + 0.03;
			tablica[losowe_probki] = wyniki[losowe_probki] + szum[losowe_probki];
		}
		for (i = 0; i < rozmiar; i++) {
			szum[i] = tablica[i];
			printf("%f\n", szum[i]);
		}
	}
	else printf("Blad\n");
	free(tablica);
}

int wczytywanie_wartosci(float wmindziedziny, float wmaxdziedziny, float *probki) {
	int var;
	float temp;
	printf("Podaj co jaką wartość mają być wyliczane wartości funkcji\n");
	while (scanf("%f", probki) == 0) {
		scanf("%*s");
	}
	fflush(stdin);
	if (*probki < 0) {
		printf("Wpisales liczbe ujemną, ale nic się nie stało\n");
		*probki = -(*probki);
	}
	if (*probki == 0) return wczytywanie_wartosci(wmindziedziny, wmaxdziedziny, probki);
	var = abs((wmaxdziedziny - wmindziedziny) / *probki);
	return var;
}

float wczytanietablicy(float *tab, char *nazwa, int *tmp1)
{
	float *temp = (float*)calloc(100, sizeof(float));
	int i;
	int z = 100;
	int rozmiartab = 0;
	float tmp = 0;
	FILE *file;
	file = fopen(nazwa, "rt");
	if (file != NULL) {
		while (fscanf(file, "%f ;\n", &tmp) == 1)
		{
			if (rozmiartab < z) {
				if (temp != NULL)
				{
					tab = temp;
					tab[rozmiartab] = tmp;
					rozmiartab++;
				}
				else
				{
					printf("Blad\n");
					free(temp);
				}
			}
			temp = (float*)realloc(tab, (rozmiartab + 100) * sizeof(float));
			z = (rozmiartab + 100);
		}
		for (i = 0; i < rozmiartab; i++) { printf("%f\n", tab[i]); }
	}
	else printf("Blad! Brak pliku\n");
	return rozmiartab;
	free(temp);
}

float *wczytanietablicy1(float *tab, char *nazwa)
{
	float *temp = (float*)calloc(100, sizeof(float));
	int z = 100;
	int rozmiartab = 0;
	float tmp = 0;
	FILE *file;
	file = fopen(nazwa, "rt");
	if (file != NULL) {
		while (fscanf(file, "%f ;\n", &tmp) == 1)
		{
			if (rozmiartab < z) {
				if (temp != NULL)
				{
					tab = temp;
					tab[rozmiartab] = tmp;
					rozmiartab++;
				}
				else
				{
					printf("Blad\n");
					free(temp);
				}
			}
			temp = (float*)realloc(tab, (rozmiartab + 100) * sizeof(float));
			z = (rozmiartab + 100);
		}
		return tab;
	}
	else printf("Blad\n");
	free(temp);
}

void odstep() {
	printf("\n");
}

int lepszyScanf()
{
	int liczba;
	scanf("%d", &liczba);
	while (getchar() != '\n');
	return liczba;
}

float *filtr(float *szum, int rozmiar) {
	int i = 0;
	int j;
	float t;
	int z;
	int b = 0;
	float *c = (float*)calloc(5, sizeof(float));
	float *temp = (float*)calloc(rozmiar, sizeof(float));
	temp[0] = szum[0];
	temp[1] = szum[1];
	temp[rozmiar - 1] = szum[rozmiar - 1];
	temp[rozmiar - 2] = szum[rozmiar - 2];
	for (z = 0; z<rozmiar - 4; z++) {
		for (b = z; b < z + 5; b++) {
			c[b - z] = szum[b];
		}
		for (j = z; j < z + 5; j++)
		{
			for (i = 0; i < 4; i++) {
				if (c[i] > c[i + 1]) {
					t = c[i];
					c[i] = c[i + 1];
					c[i + 1] = t;
				}
			}
		}
		temp[z + 2] = c[2];
	}
	return temp;
	free(c);
	free(temp);
}

void tekst_menu() {
	printf("Co chcesz zrobic?\n 0: Zamknac program\n 1: Podac wartosc co jaką mają być wyliczane wartości funkcji \n 2: Podac dziedzine \n 3: Podac wspolczynniki funkcji \n 4: Wyswietlic wyniki \n 5: Zaszumic wyniki\n 6: Zapisac szum w pliku CSV\n 7: Zapisac wyniki w pliku CSV\n 8: Wczytac szumy z pliku\n 9: Wczytac wyniki z pliku\n 10: Przefiltrowac zaszumione wyniki\n 11: Zapisac przefiltrowane wyniki w pliku CSV (ostatni wykonany filtr)\n 12: Odczytac przefiltrowane wyniki z pliku CSV\n");
}

float* filtr_ruchoma_srednia(float *dane, int r_tab, int r_okna) {
	int i, j;
	int n = (r_okna - 1) / 2;
	float temp = 0;
	float *nowe_dane = (float*)calloc(r_tab, sizeof(float));
	for (i = 0; i < n; i++) nowe_dane[i] = dane[i];
	for (i = n; i < r_tab - n; i++) {
		temp = 0;
		for (j = 0; j < r_okna; j++) temp += dane[i - n + j];
		nowe_dane[i] = temp / r_okna;
	}
	for (i = r_tab - n; i < r_tab; i++) nowe_dane[i] = dane[i];
	return nowe_dane;
}

int main() {
	float min_dziedziny = 0;
	float max_dziedziny = 0;
	float próbkowanie = 0;
	int rozmiar_tablicy_wynikowej = 0;
	int rozmiar_tablicy_wynikowej1;
	float wart_wspolczynnikow[5];
	int menu = 1;
	int menu1;
	int menu2 = 0;
	int pomocnicza = 0;
	int pomocnicza1 = 0;
	float  *wczytana_tablica = NULL;
	float  *wynik = NULL;
	float  *szum = NULL;
	float *szum1 = NULL;
	float  *filtr_mediana = NULL;
	float  *filtr_srednia = NULL;
	setlocale(LC_ALL, "polish_poland");
	srand(time(NULL));
	while (menu != 0) {
		tekst_menu();
		printf("Wybierz liczbe \n");
		menu = lepszyScanf();
		fflush(stdin);
		system("cls");
		switch (menu) {
		case 0:
			printf("Koniec programu\n");
			break;
		case 1:
			if ((min_dziedziny != 0) || (max_dziedziny != 0)) {
				rozmiar_tablicy_wynikowej = wczytywanie_wartosci(min_dziedziny, max_dziedziny, &próbkowanie);
				odstep();
				break;
			}
			else printf("Musisz najpierw podac ponizsze wartosci\n\n");
		case 2:
			dziedzina(&min_dziedziny, &max_dziedziny);
			odstep();
			break;
		case 3:
			wspolczynniki_funkcji(wart_wspolczynnikow);
			pomocnicza = 1;
			odstep();
			break;
		case 4:
			if ((rozmiar_tablicy_wynikowej != 0) && (max_dziedziny != 0) && (pomocnicza == 1)) {
				free(wynik);
				wynik = (float*)calloc(rozmiar_tablicy_wynikowej, sizeof(float));
				wartosci_funkcji(min_dziedziny, max_dziedziny, próbkowanie, wynik, wart_wspolczynnikow, rozmiar_tablicy_wynikowej);
				wyswietl(wynik, rozmiar_tablicy_wynikowej);
				odstep();
				break;
			}
			else printf("Nie mozna wykonac czynnosci bez uprzedniego podania wartosci z kroków 1, 2 ,3\n");
			odstep();
			break;
		case 5:
			if ((pomocnicza == 1) && (wynik != NULL)) {
				free(szum);
				szum = (float*)calloc(rozmiar_tablicy_wynikowej, sizeof(float));
				generator_szumu(rozmiar_tablicy_wynikowej, szum, wynik);
				odstep();
				break;
			}
			else printf("Nie można wykonac czynnosci bez uprzedniego podania wartosci kroków 1, 2 ,3 ,4\n");
			odstep();
			break;
		case 6:
			if ((wynik != NULL) && (szum != NULL)) {
				ZapisCSV(szum, rozmiar_tablicy_wynikowej, "szumy.csv");
				odstep();
				break;
			}
			else printf("Nie można wykonac czynnosci bez uprzedniego podania wartosci kroków 1, 2, 3, 4, 5\n");
			odstep();
			break;
		case 7:
			if ((pomocnicza == 1) && (wynik != NULL)) {
				ZapisCSV(wynik, rozmiar_tablicy_wynikowej, "wyniki.csv");
				odstep();
				break;
			}
			else printf("Nie można wykonac czynnosci bez uprzedniego podania wartosci kroków 1, 2 ,3 ,4 \n");
			odstep();
			break;
		case 8:
			free(wczytana_tablica);
			wczytana_tablica = (float*)calloc(100, sizeof(float));
			rozmiar_tablicy_wynikowej1 = wczytanietablicy(wczytana_tablica, "szumy.csv", &rozmiar_tablicy_wynikowej1); /* żeby nie trzeba dawać return rozmiaratab w funckji wczytanietablicy (żeby był zwykły void), tylko przypisywało tego rozmiar_tab(z funkcji) pod ten rozmiar_tablicy_znakowej1 */
			odstep();
			break;
		case 9:
			free(wczytana_tablica);
			wczytana_tablica = (float*)calloc(100, sizeof(float));
			rozmiar_tablicy_wynikowej1 = wczytanietablicy(wczytana_tablica, "wyniki.csv", &rozmiar_tablicy_wynikowej1);
			odstep();
			break;
		case 10:
			printf("Co chcialbys zrobic?\n 1: Przefiltrowac wygenerowane szumy\n 2: Przefiltrowac szumy z pliku\n");
			menu2 = lepszyScanf();
			if (menu2 == 2 && rozmiar_tablicy_wynikowej1 != 0) {
				if (rozmiar_tablicy_wynikowej1 > 0) {
					printf("Ktorym sposobem chcialbys przefiltrowac wyniki?\n 1: Mediana\n 2: Srednia ruchoma\n");
					menu1 = lepszyScanf();
					if ((menu1 == 1) || (menu1 == 2)) {
						if (menu1 == 1) {
							free(wczytana_tablica);
							free(szum1);
							filtr_mediana = (float*)calloc(rozmiar_tablicy_wynikowej1, sizeof(float));
							szum1 = (float*)calloc(rozmiar_tablicy_wynikowej1, sizeof(float));
							wczytana_tablica = (float*)calloc(rozmiar_tablicy_wynikowej1, sizeof(float));
							szum1 = wczytanietablicy1(wczytana_tablica, "szumy.csv");
							filtr_mediana = filtr(szum1, rozmiar_tablicy_wynikowej1);
							odstep();
							printf("Przefiltrowane wyniki\n");
							system("cls");
							wyswietl(filtr_mediana, rozmiar_tablicy_wynikowej1);
							pomocnicza1 = 1;
							odstep();
							break;
						}
						else if (menu1 == 2) {
							free(wczytana_tablica);
							free(szum1);
							filtr_srednia = (float*)calloc(rozmiar_tablicy_wynikowej1, sizeof(float));
							szum1 = (float*)calloc(rozmiar_tablicy_wynikowej1, sizeof(float));
							wczytana_tablica = (float*)calloc(rozmiar_tablicy_wynikowej1, sizeof(float));
							szum1 = wczytanietablicy1(wczytana_tablica, "szumy.csv");
							filtr_srednia = filtr_ruchoma_srednia(szum1, rozmiar_tablicy_wynikowej1, 5);
							odstep();
							printf("Przefiltrowane wyniki\n");
							system("cls");
							wyswietl(filtr_srednia, rozmiar_tablicy_wynikowej1);
							pomocnicza1 = 2;
							break;
						}
					}
					else printf("BLAD! Nie podales jednej z powyzszych cyfr\n");
					odstep();
					break;
				}
				else printf("Nie mozna wykonac czynnosci bez uprzedniego wczytania szumów z pliku\n");
				odstep();
			}
			else if (menu2 == 1 && rozmiar_tablicy_wynikowej != 0) {
				printf("Ktorym sposobem chcialbys przefiltrowac wyniki?\n 1: Mediana\n 2: Srednia ruchoma\n");
				menu1 = lepszyScanf();
				if ((menu1 == 1) || (menu1 == 2)) {
					if ((rozmiar_tablicy_wynikowej != 0) && (menu1 == 1)) {
						filtr_mediana = (float*)calloc(rozmiar_tablicy_wynikowej, sizeof(float));
						filtr_mediana = filtr(szum, rozmiar_tablicy_wynikowej);
						odstep();
						printf("Przefiltrowane wyniki\n");
						wyswietl(filtr_mediana, rozmiar_tablicy_wynikowej);
						pomocnicza1 = 1;
						odstep();
						break;
					}
					else if ((rozmiar_tablicy_wynikowej != 0) && (menu1 == 2)) {
						filtr_srednia = (float*)calloc(rozmiar_tablicy_wynikowej, sizeof(float));
						filtr_srednia = filtr_ruchoma_srednia(szum, rozmiar_tablicy_wynikowej, 5);
						odstep();
						printf("Przefiltrowane wyniki\n");
						wyswietl(filtr_srednia, rozmiar_tablicy_wynikowej);
						pomocnicza1 = 2;
						break;
					}
				}
				else printf("BLAD! Nie podales jednej z powyzszych cyfr\n");
				odstep();
				break;
			}
			else printf("Nie mozna wykonac czynnosci bez uprzedniego wygenerowania szumów\n");
			odstep();
			break;
		case 11:
			if (rozmiar_tablicy_wynikowej1 > 0) {
				if (pomocnicza1 == 1) {
					ZapisCSV(filtr_mediana, rozmiar_tablicy_wynikowej1, "filtr.csv");
					odstep();
					break;
				}
				else if (pomocnicza1 == 2) {
					ZapisCSV(filtr_srednia, rozmiar_tablicy_wynikowej1, "filtr.csv");
					odstep();
					break;
				}
			}
			else printf("Nie można wykonac czynnosci bez uprzedniego przefiltrowania wynikow\n");
			odstep();
			break;
		case 12:
			free(wczytana_tablica);
			wczytana_tablica = (float*)calloc(100, sizeof(float));
			wczytanietablicy(wczytana_tablica, "filtr.csv", rozmiar_tablicy_wynikowej1);
			odstep();
			break;
		default: printf("Blad, Podaj liczbe z ponizszego zakresu\n");
			odstep();
		}
	}
	free(wynik);
	free(szum);
	free(szum1);
	free(filtr_mediana);
	free(filtr_srednia);
	free(wczytana_tablica);
	system("pause");
}
